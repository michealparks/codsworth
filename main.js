(function(){'use strict';var u=Math.floor;async function a(){const a=window.indexedDB.open("galeri",3);return a.onupgradeneeded=function(a){const b=a.target.result;b.objectStoreNames.contains("images")||b.createObjectStore("images",{keyPath:"id",autoIncrement:!0}),b.objectStoreNames.contains("artObjects")||b.createObjectStore("artObjects",{keyPath:"id",autoIncrement:!0})},v=await e(a),v}async function b(a,b){return e(v.transaction(a,"readwrite").objectStore(a).put({...b,created:new Date().getTime()}))}async function c(a,b){return e(v.transaction(a).objectStore(a).get(b))}async function d(a){return e(v.transaction(a,"readwrite").objectStore(a).clear())}function e(a){return new Promise(function(b){function c({target:a}){b(a.result)}a.onsuccess=c,a.onerror=c,a.onabort=c})}function f(a){this.subscribers.push(a)}function g(a){this.subscribers.splice(this.subscribers.indexOf(a),1)}function h(a){this.state=this.reducer(this.state,a);for(let b=0,c=this.subscribers.length;b<c;b++)this.subscribers[b](this.state)}function i(){return this.state}function j(a,b){return{state:b,reducer:a,subscribe:f,unsubscribe:g,subscribers:[],dispatch:h,getState:i}}async function k(){localStorage.getItem("artObjectsId")}async function l(){const a=localStorage.getItem("artObjectsId");if(a){const b=await c("artObjects",parseInt(a,10)),{artObjects:d}=b;return d&&0<d.length?d:(localStorage.removeItem("artObjectsId"),l())}else{const a=await o("Wikipedia:Featured_pictures/Artwork/Paintings");if(!a)return;const b=m(a);return x.dispatch({type:"ADD_ARTOBJECTS",artObjects:b}),b}}function m(a){const b=new DOMParser().parseFromString(a,"text/html");return Array.from(b.querySelectorAll(".gallerybox")).map(function(a){const b=a.querySelector("img")||{src:""},c=a.querySelectorAll(".gallerytext a"),d=a.querySelector(".gallerytext b"),e=d.children[0]?d.children[0]:d,f=1<c.length?c[1]:c[0],g=b.src.split("/").slice(0,-1),h=g.concat(`2500px-${g[g.length-1]}`).join("/"),i=e.innerText||"",j=e.href,k=f.innerText||"",l=f.href;return{src:`https://upload.wikimedia.org${h.split("//upload.wikimedia.org").pop()}`,title:i,author:k,titleLink:j?`https://wikipedia.org/wiki${j.split("/wiki").pop()}`:"",authorLink:l?`https://wikipedia.org/wiki${l.split("/wiki").pop()}`:"",provider:"Wikipedia",providerLink:"https://wikipedia.org",blob:void 0,timestamp:void 0}})}function n(a){const[b]=a.splice(u(Math.random()*a.length),1)||[];return x.dispatch({type:"ADD_ARTOBJECTS",artObjects:a}),b}async function o(a){try{const b=await window.fetch(`https://en.wikipedia.org/w/api.php?action=parse&prop=text&page=${a}&format=json&origin=*`),c=await b.json();return c.parse.text["*"]}catch(a){console.error(a)}}async function p(){const a=localStorage.getItem("imageId");if(a)return c("images",parseInt(a,10));const b=await q();if(!b)return p();const d=await r(b);return d?b:p()}function q(){return z.randomArtObject()}async function r(a){const b=await s(a.src);return!!b&&(a.blob=b,a.timestamp=Date.now(),!0)}async function s(a){try{const b=await window.fetch(a.replace("chrome-extension://","https://")),c=await b.blob();return c}catch(a){console.error(a)}}function t(a){const b=document.getElementById("background"),c=new window.Image,d=URL.createObjectURL(a.blob);c.onload=function(){c.naturalWidth<c.naturalHeight&&(b.style.backgroundPosition="50% 0"),b.style.backgroundImage=`url('${d}')`;const e=document.getElementById("title");e.textContent=a.title,a.titleLink?(e.href=a.titleLink,e.style.pointerEvents="auto"):e.style.pointerEvents="none";const f=document.getElementById("author");f.textContent=a.authorLink?`by ${a.author}`:"",a.authorLink?(f.href=a.authorLink,e.style.pointerEvents="auto"):e.style.pointerEvents="none";const g=document.getElementById("provider");g.textContent=`from ${a.provider}`,g.href=a.providerLink},c.src=d,w.unsubscribe(t)}let v;const w=j(function(a,b){switch(b.type){case"ADD_ARTOBJECT":return b.artObject;default:return a;}}),x=j(function(a,b){switch(b.type){case"ADD_ARTOBJECTS":return b.artObjects;default:return a;}});w.subscribe(async function(a){const c=await b("images",a);localStorage.setItem("imageId",c)}),x.subscribe(async function(a){const c=await b("artObjects",{artObjects:a});localStorage.setItem("artObjectsId",c)});const y={randomArtObject:async function(){const a=await k();return a?removeRandomArtObject(a):void 0}},z={randomArtObject:async function(){const a=await l();return a?n(a):void 0}};let A=!1;const B={addListeners:function(){document.getElementById("btn-refresh").addEventListener("click",async function(a){const b=a.target;if(!A){A=!0,b.classList.remove("active"),b.classList.add("active"),localStorage.removeItem("imageId"),w.subscribe(t);const a=await p();w.dispatch({type:"ADD_ARTOBJECT",artObject:a}),b.addEventListener("animationiteration",function a(){b.classList.remove("active"),b.removeEventListener("animationiteration",a)}),A=!1}}),w.subscribe(t)}};(async function(){navigator.storage.persist(),await a(),B.addListeners();const b=await p();if(w.dispatch({type:"ADD_ARTOBJECT",artObject:b}),b.timestamp<Date.now()-7200000){localStorage.removeItem("imageId");const a=await p();w.dispatch({type:"ADD_ARTOBJECT",artObject:a})}window.flush=function(){localStorage.removeItem("artObjectsId"),localStorage.removeItem("imageId");try{d("images")}catch(a){console.error(a)}try{d("artObjects")}catch(a){console.error(a)}}})()})();
